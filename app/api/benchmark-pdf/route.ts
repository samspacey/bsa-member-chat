import { NextRequest, NextResponse } from "next/server";
import { jsPDF } from "jspdf";
import nodemailer from "nodemailer";
import { getBenchmarkForSociety } from "../../../lib/benchmark";
import societiesData from "../../../societies.json";

interface Society {
  id: string;
  name: string;
  shortName: string;
  emoji: string;
  region: string;
  size: string;
  tagline: string;
  color: string;
}

const societies: Society[] = societiesData as Society[];

const ordinal = (n: number) => {
  const s = ["th", "st", "nd", "rd"];
  const v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
};

function generatePDF(society: Society, benchmarkData: ReturnType<typeof getBenchmarkForSociety>) {
  if (!benchmarkData) throw new Error("No benchmark data");

  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 20;
  const contentWidth = pageWidth - margin * 2;
  let y = 25;
  const totalSocieties = benchmarkData.totalSocieties;

  doc.setFontSize(20);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(15, 48, 87);
  doc.text(society.name, pageWidth / 2, y, { align: "center" });
  y += 10;

  doc.setFontSize(14);
  doc.setFont("helvetica", "normal");
  doc.text("Member Experience Benchmark Report", pageWidth / 2, y, { align: "center" });
  y += 10;

  doc.setFontSize(10);
  doc.setTextColor(100, 100, 100);
  doc.text("Generated by Woodhurst Consulting | BSA Member Chat", pageWidth / 2, y, { align: "center" });
  y += 7;

  const dateStr = new Date().toLocaleDateString("en-GB", { day: "numeric", month: "long", year: "numeric" });
  doc.setFontSize(9);
  doc.text(`Report generated: ${dateStr}`, pageWidth / 2, y, { align: "center" });
  y += 12;

  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.5);
  doc.line(margin, y, pageWidth - margin, y);
  y += 10;

  doc.setFontSize(9);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(80, 80, 80);

  const colFactor = margin;
  const colScore = margin + contentWidth * 0.45;
  const colAvg = margin + contentWidth * 0.58;
  const colRank = margin + contentWidth * 0.71;
  const colIndicator = margin + contentWidth * 0.82;

  doc.text("Factor", colFactor, y);
  doc.text("Score", colScore, y);
  doc.text("Avg", colAvg, y);
  doc.text("Rank", colRank, y);
  doc.text("Status", colIndicator, y);
  y += 3;

  doc.setDrawColor(180, 180, 180);
  doc.setLineWidth(0.3);
  doc.line(margin, y, pageWidth - margin, y);
  y += 7;

  for (const s of benchmarkData.scores) {
    const diff = s.score - s.average;
    let status: string;
    let statusColor: [number, number, number];

    if (diff >= 1.0) { status = "Above avg"; statusColor = [22, 163, 74]; }
    else if (diff > -1.0) { status = "Near avg"; statusColor = [180, 130, 20]; }
    else { status = "Below avg"; statusColor = [220, 50, 50]; }

    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.setTextColor(40, 40, 40);
    doc.text(s.factor, colFactor, y);

    doc.setFont("helvetica", "bold");
    doc.text(s.score.toFixed(1), colScore, y);

    doc.setFont("helvetica", "normal");
    doc.setTextColor(120, 120, 120);
    doc.text(s.average.toFixed(1), colAvg, y);
    doc.text(`${ordinal(s.rank)} of ${totalSocieties}`, colRank, y);

    doc.setTextColor(...statusColor);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(8);
    doc.text(status, colIndicator, y);

    y += 4;
    const barMaxWidth = contentWidth * 0.35;
    doc.setFillColor(235, 235, 235);
    doc.rect(colFactor, y, barMaxWidth, 3, "F");

    const scoreWidth = (s.score / 10) * barMaxWidth;
    if (diff >= 1.0) doc.setFillColor(34, 197, 94);
    else if (diff > -1.0) doc.setFillColor(250, 204, 21);
    else doc.setFillColor(239, 68, 68);
    doc.rect(colFactor, y, scoreWidth, 3, "F");

    const avgX = colFactor + (s.average / 10) * barMaxWidth;
    doc.setDrawColor(80, 80, 80);
    doc.setLineWidth(0.5);
    doc.line(avgX, y - 0.5, avgX, y + 3.5);

    y += 10;
    doc.setDrawColor(230, 230, 230);
    doc.setLineWidth(0.2);
    doc.line(margin, y - 2, pageWidth - margin, y - 2);
  }

  y += 5;
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.5);
  doc.line(margin, y, pageWidth - margin, y);
  y += 8;

  doc.setFontSize(8);
  doc.setFont("helvetica", "bold");
  doc.setTextColor(80, 80, 80);
  doc.text("Methodology", margin, y);
  y += 5;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(7.5);
  doc.setTextColor(120, 120, 120);
  const methodology = `Scores derived from analysis of customer reviews across Smart Money People and Trustpilot. Rankings are out of ${totalSocieties} building societies analysed. Scores range from 1-10 where 10 is best.`;
  const methodLines = doc.splitTextToSize(methodology, contentWidth);
  doc.text(methodLines, margin, y);

  doc.setFontSize(7);
  doc.setTextColor(160, 160, 160);
  doc.text("© Woodhurst Consulting | bsa-member-chat | Confidential", pageWidth / 2, doc.internal.pageSize.getHeight() - 10, { align: "center" });

  return Buffer.from(doc.output("arraybuffer"));
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { email, societyId } = body;

    if (!societyId) {
      return NextResponse.json({ error: "societyId is required" }, { status: 400 });
    }

    const society = societies.find((s: Society) => s.id === societyId);
    if (!society) {
      return NextResponse.json({ error: "Society not found" }, { status: 404 });
    }

    const benchmarkData = getBenchmarkForSociety(societyId);
    if (!benchmarkData) {
      return NextResponse.json({ error: "Benchmark data not available" }, { status: 404 });
    }

    const pdfBuffer = generatePDF(society, benchmarkData);

    // If email provided, send via SMTP
    if (email) {
      if (!email.includes("@") || !email.includes(".")) {
        return NextResponse.json({ error: "Invalid email" }, { status: 400 });
      }

      const smtpUser = process.env.SMTP_USER;
      const smtpPass = process.env.SMTP_PASS;

      if (!smtpUser || !smtpPass) {
        console.error("[EMAIL] SMTP credentials not configured");
        return NextResponse.json({ error: "Email service not configured" }, { status: 500 });
      }

      const transporter = nodemailer.createTransport({
        host: process.env.SMTP_HOST || "smtp.mail.me.com",
        port: Number(process.env.SMTP_PORT || 587),
        secure: false,
        auth: { user: smtpUser, pass: smtpPass },
      });

      await transporter.sendMail({
        from: `"Woodhurst Consulting" <${process.env.SMTP_FROM || smtpUser}>`,
        to: email,
        subject: `${society.name} — Member Experience Benchmark Report`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #0f3057;">Your Benchmark Report is Ready</h2>
            <p>Hi,</p>
            <p>Please find attached the Member Experience Benchmark Report for <strong>${society.name}</strong>.</p>
            <p>This report analyses customer reviews across Smart Money People and Trustpilot to benchmark ${society.shortName} against ${benchmarkData.totalSocieties} other building societies across key experience factors.</p>
            <p>If you'd like to discuss these insights or explore how Woodhurst can help improve your member experience, we'd love to hear from you.</p>
            <p style="margin-top: 24px;">Best regards,<br/><strong>Woodhurst Consulting</strong><br/>Data &amp; Digital Advisory</p>
            <hr style="border: none; border-top: 1px solid #eee; margin: 24px 0;" />
            <p style="font-size: 11px; color: #999;">Generated by BSA Member Chat | bsa-member-chat.vercel.app</p>
          </div>
        `,
        attachments: [{
          filename: `${societyId}-benchmark-report.pdf`,
          content: pdfBuffer,
          contentType: "application/pdf",
        }],
      });

      console.log(`[EMAIL] Sent to ${email} for ${society.name}`);
      return NextResponse.json({ success: true, message: "Report sent to your email" });
    }

    // No email — return PDF as download
    return new NextResponse(pdfBuffer, {
      status: 200,
      headers: {
        "Content-Type": "application/pdf",
        "Content-Disposition": `attachment; filename="${societyId}-benchmark-report.pdf"`,
        "Content-Length": pdfBuffer.length.toString(),
      },
    });
  } catch (error) {
    console.error("[PDF] Error:", error);
    return NextResponse.json({ error: "Failed to generate report" }, { status: 500 });
  }
}
