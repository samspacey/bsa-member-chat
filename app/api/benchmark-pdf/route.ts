import { NextRequest, NextResponse } from "next/server";
import fs from "fs";
import path from "path";
import { jsPDF } from "jspdf";
import { getBenchmarkForSociety } from "../../../lib/benchmark";
import societiesData from "../../../societies.json";

interface Society {
  id: string;
  name: string;
  shortName: string;
  emoji: string;
  region: string;
  size: string;
  tagline: string;
  color: string;
}

const societies: Society[] = societiesData as Society[];

function saveLead(email: string, societyId: string, societyName: string) {
  const leadsFile = path.join(process.cwd(), "data", "leads.json");
  const dir = path.dirname(leadsFile);
  if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });

  let leads = [];
  try {
    if (fs.existsSync(leadsFile)) {
      leads = JSON.parse(fs.readFileSync(leadsFile, "utf8"));
    }
  } catch {
    leads = [];
  }

  leads.push({
    email,
    societyId,
    societyName,
    timestamp: new Date().toISOString(),
  });

  fs.writeFileSync(leadsFile, JSON.stringify(leads, null, 2), "utf8");
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { email, societyId } = body;

    if (!email || !societyId) {
      return NextResponse.json(
        { error: "email and societyId are required" },
        { status: 400 }
      );
    }

    // Validate email
    if (!email.includes("@") || !email.includes(".")) {
      return NextResponse.json(
        { error: "Invalid email address" },
        { status: 400 }
      );
    }

    // Find society
    const society = societies.find((s: Society) => s.id === societyId);
    if (!society) {
      return NextResponse.json(
        { error: "Society not found" },
        { status: 404 }
      );
    }

    // Get benchmark data
    const benchmarkData = getBenchmarkForSociety(societyId);
    if (!benchmarkData) {
      return NextResponse.json(
        { error: "Benchmark data not available" },
        { status: 404 }
      );
    }

    // Generate PDF
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 20;
    const contentWidth = pageWidth - margin * 2;
    let y = 25;

    // --- Title ---
    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(15, 48, 87); // Dark navy
    const title = `${society.name}`;
    doc.text(title, pageWidth / 2, y, { align: "center" });
    y += 10;

    doc.setFontSize(14);
    doc.setFont("helvetica", "normal");
    doc.text("Member Experience Benchmark Report", pageWidth / 2, y, { align: "center" });
    y += 10;

    // --- Subtitle ---
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text("Generated by Woodhurst Consulting | BSA Member Chat", pageWidth / 2, y, { align: "center" });
    y += 7;

    // --- Date ---
    const dateStr = new Date().toLocaleDateString("en-GB", {
      day: "numeric",
      month: "long",
      year: "numeric",
    });
    doc.setFontSize(9);
    doc.text(`Report generated: ${dateStr}`, pageWidth / 2, y, { align: "center" });
    y += 12;

    // --- Divider ---
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.line(margin, y, pageWidth - margin, y);
    y += 10;

    // --- Table Header ---
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(80, 80, 80);

    const colFactor = margin;
    const colScore = margin + contentWidth * 0.45;
    const colAvg = margin + contentWidth * 0.58;
    const colRank = margin + contentWidth * 0.71;
    const colIndicator = margin + contentWidth * 0.82;

    doc.text("Factor", colFactor, y);
    doc.text("Score", colScore, y);
    doc.text("Avg", colAvg, y);
    doc.text("Rank", colRank, y);
    doc.text("Status", colIndicator, y);
    y += 3;

    doc.setDrawColor(180, 180, 180);
    doc.setLineWidth(0.3);
    doc.line(margin, y, pageWidth - margin, y);
    y += 7;

    // --- Table Rows ---
    const ordinal = (n: number) => {
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    };

    for (const s of benchmarkData.scores) {
      const diff = s.score - s.average;
      let status: string;
      let statusColor: [number, number, number];

      if (diff >= 1.0) {
        status = "▲ Above avg";
        statusColor = [22, 163, 74]; // green
      } else if (diff > -1.0) {
        status = "● Near avg";
        statusColor = [180, 130, 20]; // amber
      } else {
        status = "▼ Below avg";
        statusColor = [220, 50, 50]; // red
      }

      // Factor name
      doc.setFont("helvetica", "normal");
      doc.setFontSize(9);
      doc.setTextColor(40, 40, 40);
      doc.text(s.factor, colFactor, y);

      // Score
      doc.setFont("helvetica", "bold");
      doc.text(s.score.toFixed(1), colScore, y);

      // Average
      doc.setFont("helvetica", "normal");
      doc.setTextColor(120, 120, 120);
      doc.text(s.average.toFixed(1), colAvg, y);

      // Rank
      doc.text(ordinal(s.rank), colRank, y);

      // Status indicator
      doc.setTextColor(...statusColor);
      doc.setFont("helvetica", "bold");
      doc.setFontSize(8);
      doc.text(status, colIndicator, y);

      y += 4;

      // Score bar visual
      const barY = y;
      const barHeight = 3;
      const barMaxWidth = contentWidth * 0.35;

      // Background
      doc.setFillColor(235, 235, 235);
      doc.rect(colFactor, barY, barMaxWidth, barHeight, "F");

      // Score bar
      const scoreWidth = (s.score / 10) * barMaxWidth;
      if (diff >= 1.0) {
        doc.setFillColor(34, 197, 94); // green
      } else if (diff > -1.0) {
        doc.setFillColor(250, 204, 21); // amber
      } else {
        doc.setFillColor(239, 68, 68); // red
      }
      doc.rect(colFactor, barY, scoreWidth, barHeight, "F");

      // Average marker
      const avgX = colFactor + (s.average / 10) * barMaxWidth;
      doc.setDrawColor(80, 80, 80);
      doc.setLineWidth(0.5);
      doc.line(avgX, barY - 0.5, avgX, barY + barHeight + 0.5);

      y += 10;

      // Light separator
      doc.setDrawColor(230, 230, 230);
      doc.setLineWidth(0.2);
      doc.line(margin, y - 2, pageWidth - margin, y - 2);
    }

    y += 5;

    // --- Methodology Note ---
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.line(margin, y, pageWidth - margin, y);
    y += 8;

    doc.setFontSize(8);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(80, 80, 80);
    doc.text("Methodology", margin, y);
    y += 5;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(7.5);
    doc.setTextColor(120, 120, 120);
    const methodology =
      "Scores derived from analysis of customer reviews across Smart Money People and Trustpilot. " +
      "Scores range from 1-10 where 10 is best. Industry average calculated across all building societies analysed.";
    const methodLines = doc.splitTextToSize(methodology, contentWidth);
    doc.text(methodLines, margin, y);
    y += methodLines.length * 4 + 8;

    // --- Footer ---
    doc.setFontSize(7);
    doc.setTextColor(160, 160, 160);
    doc.text(
      "© Woodhurst Consulting | bsa-member-chat | Confidential",
      pageWidth / 2,
      doc.internal.pageSize.getHeight() - 10,
      { align: "center" }
    );

    // Save PDF locally
    const pdfDir = path.join(process.cwd(), "data", "pdfs");
    if (!fs.existsSync(pdfDir)) fs.mkdirSync(pdfDir, { recursive: true });

    const pdfBuffer = Buffer.from(doc.output("arraybuffer"));
    const pdfFilename = `${societyId}-benchmark-${Date.now()}.pdf`;
    const pdfPath = path.join(pdfDir, pdfFilename);
    fs.writeFileSync(pdfPath, pdfBuffer);

    console.log(`[PDF] Generated: ${pdfPath}`);
    console.log(`[PDF] Email: ${email} | Society: ${society.name}`);

    // Save lead
    saveLead(email, societyId, society.name);
    console.log(`[LEAD] Saved lead for ${email}`);

    return NextResponse.json({
      success: true,
      message: "Report generated successfully",
      pdfPath: pdfFilename,
    });
  } catch (error) {
    console.error("[PDF] Error generating benchmark PDF:", error);
    return NextResponse.json(
      { error: "Failed to generate report" },
      { status: 500 }
    );
  }
}
